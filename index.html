<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PQC Key Lab ‚Äî SLH-DSA + ML-KEM (RFC 9580 / draft-pqc-openpgp)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
	body {
	  font-family: system-ui, sans-serif;
	  background: #f5f7fa;
	  color: #2c3e50;
	  margin: 0;
	  padding: 1rem;
	}
	.container { max-width: 720px; margin: auto; }
	h1, h2 { color: #1a5f7a; }
	.panel {
	  background: white;
	  border-radius: 8px;
	  padding: 1.5rem;
	  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
	  margin-top: 1rem;
	}
	label { display: block; font-weight: bold; margin-top: 1rem; }
	select, input[type="text"] {
	  width: 100%; padding: 8px; margin-top: 0.5rem;
	  border-radius: 4px; border: 1px solid #ccc;
	}
	.btn-row { display: flex; gap: 0.5rem; margin-top: 1rem; }
	button {
	  padding: 0.65rem 1.2rem;
	  border-radius: 4px; border: none; cursor: pointer;
	  font-weight: bold;
	}
	.btn-primary { background: #1a5f7a; color: white; flex: 2; }
	.btn-secondary { background: #e0ecf1; color: #333; flex: 1; }
	button:hover { opacity: 0.95; }
	.warn-box {
	  background: #fff3cd;
	  border-left: 4px solid #ffc107;
	  padding: 0.75rem; margin-top: 1rem; border-radius: 4px;
	}
	textarea {
	  width: 100%; height: 250px; margin-top: 1rem;
	  font-family: monospace; padding: 0.5rem;
	}
	#output { background: #fafafa; white-space: pre-wrap; word-break: break-all; }
  </style>

  <!-- Load noble libraries via dynamic import so failures are visible in the UI -->
  <script>
  document.addEventListener('DOMContentLoaded', async function () {
	const out    = document.getElementById('output');
	const genBtn = document.getElementById('genBtn');

	// Disable button until libraries finish loading
	genBtn.disabled = true;
	out.textContent = 'Loading cryptographic libraries‚Ä¶';

	// Fetch only the modules we need; show a clear error if any import fails
	let ml_kem1024, slh_dsa_shake_256s, XWing, KitchenSink_ml_kem768_x25519, x448;
	try {
	  const results = await Promise.all([
		import('https://esm.sh/@noble/post-quantum/ml-kem'),
		import('https://esm.sh/@noble/post-quantum/slh-dsa'),
		import('https://esm.sh/@noble/post-quantum/hybrid'),
		import('https://esm.sh/@noble/curves/x448'),
	  ]);
	  ({ ml_kem1024 }                       = results[0]);
	  ({ slh_dsa_shake_256s }               = results[1]);
	  ({ XWing, KitchenSink_ml_kem768_x25519 } = results[2]);
	  ({ x448 }                             = results[3]);
	  genBtn.disabled = false;
	  out.textContent = '‚úÖ Libraries loaded. Click "Generate Key" to start.';
	} catch (e) {
	  out.textContent = 'ERROR: Failed to load cryptographic libraries.\n\n'
		+ e.message
		+ '\n\nCheck your internet connection or try refreshing.';
	  return;
	}

	// === Helper: Uint8Array ‚Üí Base64 ===
	function toBase64(bytes) {
	  let s = '';
	  for (let i = 0; i < bytes.length; i++) s += String.fromCharCode(bytes[i]);
	  return btoa(s);
	}

	// === Helper: ASCII-armored OpenPGP-style block ===
	function armored(label, bytes) {
	  const b64 = toBase64(bytes).replace(/.{1,76}/g, '$&\n');
	  return `-----BEGIN PGP ${label} KEY BLOCK-----\n\n${b64}-----END PGP ${label} KEY BLOCK-----`;
	}

	// === Generate Hybrid PQC Key ===
	async function generatePQCKey(mode = 'x448') {
	  out.textContent = 'Generating‚Ä¶ SLH-DSA key gen may take 10‚Äì30 s, please wait.';
	  await new Promise(r => setTimeout(r, 50));

	  try {
		// Primary: SLH-DSA-SHAKE-256s signing key (CPU-intensive, synchronous)
		const { publicKey: slhPK, secretKey: slhSK } = slh_dsa_shake_256s.keygen();

		// Subkey: hybrid KEM ‚Äî use the proper noble hybrid implementations
		let kemPK, kemSK;
		if (mode === 'xwing') {
		  // XWing = ML-KEM-768 + X25519 (draft-connolly-cfrg-xwing-kem)
		  ({ publicKey: kemPK, secretKey: kemSK } = XWing.keygen());
		} else if (mode === 'kitchensink') {
		  // KitchenSink = ML-KEM-768 + X25519 + SHAKE256/HKDF
		  ({ publicKey: kemPK, secretKey: kemSK } = KitchenSink_ml_kem768_x25519.keygen());
		} else {
		  // RFC 9580 v6 default: ML-KEM-1024 + X448
		  const { publicKey: mlPK, secretKey: mlSK } = ml_kem1024.keygen();
		  const x448SK = x448.utils.randomPrivateKey();
		  const x448PK = x448.getPublicKey(x448SK);
		  // Concatenate ML-KEM-1024 pk + X448 pk as the combined subkey
		  kemPK = new Uint8Array([...mlPK, ...x448PK]);
		  kemSK = new Uint8Array([...mlSK, ...x448SK]);
		}

		// Produce ASCII-armored output
		const primary = armored("PUBLIC", slhPK);
		const subkey  = armored("PUBLIC", kemPK);
		const all = `${primary}\n\n${subkey}`;

		out.textContent = all;

		const blob = new Blob([all], { type: 'text/plain' });
		window.pqcBlob = blob;
		window.pqcKeys = { slhPK, slhSK, kemPK, kemSK };

		// Auto-download
		const a = document.createElement('a');
		a.href = URL.createObjectURL(blob);
		a.download = `pqc-key-${mode}-${Date.now()}.asc`;
		document.body.appendChild(a);
		a.click();
		document.body.removeChild(a);
	  } catch (e) {
		out.textContent = 'ERROR during key generation:\n\n' + e.message;
		console.error(e);
	  }
	}

	// Expose for inline onclick handlers
	window.generatePQCKey = generatePQCKey;
  });
  </script>
</head>

<body>
  <div class="container">
	<h1>üîê PQC Key Lab (RFC 9580 v6 / OpenPGP draft)</h1>
	<p>Generate hybrid PQC keys: <strong>SLH-DSA-SHAKE-256s</strong> (signing) + <strong>ML-KEM+X448 / XWing / KitchenSink</strong> (encryption)</p>

	<div class="panel" id="keygen">
	  <label>Choose PQC Profile</label>
	  <select id="profileMode">
		<option value="x448" selected>SLH-DSA + ML-KEM-1024/X448 (XWing-style, RFC 9580)</option>
		<option value="xwing">XWing (ML-KEM-768 + X25519, SHAKE256/HKDF)</option>
		<option value="kitchensink">KitchenSink (ML-KEM-768 + X25519, SHAKE256/HKDF)</option>
	  </select>

	  <div class="warn-box">
		‚ö†Ô∏è SLH-DSA signing is CPU-intensive. Key generation may take 10‚Äì30 seconds.
		<br>This is expected for hash-based signatures. Browser tab must stay active.
	  </div>

	  <label>User ID</label>
	  <input type="text" id="userId" value="PQC Test User <pqc@example.org>" />

	  <div class="btn-row">
		<button id="genBtn" class="btn btn-primary" onclick="generatePQCKey(document.getElementById('profileMode').value)">
		  ‚ö° Generate Key
		</button>
	  </div>

	  <label>ASCII-Armored .asc Output</label>
	  <textarea id="output" placeholder="Keys will appear here..."></textarea>

	  <div class="btn-row">
		<button class="btn btn-secondary" onclick="
		  const blob = window.pqcBlob || new Blob([document.getElementById('output').value]);
		  const a = document.createElement('a');
		  a.href = URL.createObjectURL(blob);
		  a.download = 'pqc-key.asc';
		  document.body.appendChild(a); a.click(); document.body.removeChild(a);
		">‚¨á Download .asc</button>
	  </div>
	</div>

	<footer style="margin-top: 2rem; font-size: 0.9rem; color: #7f8c8d;">
	  <p>Uses <strong><a href="https://github.com/paulmillr/noble-post-quantum">noble-post-quantum</a></strong> + <strong><a href="https://github.com/paulmillr/noble-curves">noble-curves</a></strong> + <strong><a href="https://github.com/paulmillr/noble-hashes">noble-hashes</a></strong>.</p>
	  <p>Key generation uses SHA3-512 for SLH-DSA (per draft-ietf-openpgp-pqc-12)</p>
	</footer>
  </div>
</body>
</html>
